<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Market Signals Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body { font-family: Arial, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; padding:20px; }
h1 { text-align:center; margin-bottom:25px; }

.tabs { display:flex; gap:10px; margin-bottom:20px; }
.tab { cursor:pointer; padding:10px 15px; background:#111827; border-radius:8px; }
.tab.active { background:#374151; }
.tabcontent { display:none; }
.tabcontent.active { display:block; }

.dashboard { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:20px; }

.card { position:relative; background:#111827; border-radius:12px; padding:20px; box-shadow:0 4px 12px rgba(0,0,0,0.4); transition:0.3s; overflow:hidden; }
.card h2 { margin-top:0; font-size:18px; border-bottom:1px solid #374151; padding-bottom:8px; }

.row { 
    display:flex; 
    justify-content:space-between; 
    margin:5px 0; 
    border-bottom: 1px solid #1f2937; 
    padding-bottom: 4px; 
}
.row:last-child { border-bottom: none; }
.label { color:#9ca3af; }
.value { font-weight:bold; }

/* Gradient bar */
.gradient-bar {
    position: relative;
    height: 6px;
    width: 100%;
    border-radius: 0 0 12px 12px;
    background: linear-gradient(to right, #ff0000, #f87171, #facc15, #22c55e, #00ff80);
    overflow: hidden;
    margin-top: 10px;
}

/* Gradient fill */
.gradient-fill {
    position: absolute;
    height: 100%;
    width: 50%;
    border-radius: 0 0 12px 12px;
    background: rgba(255,255,255,0.2);
    transition: width 0.5s;
}

/* Vertical black indicator line */
.vertical-indicator {
    position: absolute;
    top: 0;
    width: 2px;
    height: 100%;
    background: #000;
    transition: left 0.5s;
}

/* Sentiment text colors */
.value.bullish { color: #22c55e; font-weight:bold; }
.value.strong-bullish { color: #00ff80; font-weight:bold; }
.value.neutral { color: #facc15; font-weight:bold; }
.value.bearish { color: #f87171; font-weight:bold; }
.value.strong-bearish { color: #ff0000; font-weight:bold; }

.footer { text-align:center; margin-top:25px; font-size:13px; color:#9ca3af; }
</style>
</head>
<body>

<h1>ðŸ“Š Market Signals Dashboard</h1>

<div class="tabs">
    <div class="tab active" data-tab="indicators">Indicators</div>
    <div class="tab" data-tab="marketbias">Market Bias</div>
</div>

<div id="indicators" class="tabcontent active">
    <div class="dashboard">

        <!-- INDICES -->
        <div class="card" id="cardIndices" data-sentiment="0">
            <h2>Index Spot Values</h2>
            <div class="row"><span class="label">NIFTY 50</span><span id="nifty50" class="value">--</span></div>
            <div class="row"><span class="label">BANK NIFTY</span><span id="banknifty" class="value">--</span></div>
            <div class="row"><span class="label">SENSEX</span><span id="sensex" class="value">--</span></div>
            <div class="gradient-bar">
                <div class="gradient-fill"></div>
                <div class="vertical-indicator" id="cardIndicesIndicator"></div>
            </div>
        </div>

        <!-- VIX -->
        <div class="card" id="cardVIX" data-sentiment="0">
            <h2>VIX</h2>
            <div class="row"><span class="label">Value</span><span id="vix" class="value">--</span></div>
            <div class="row"><span class="label">Sentiment</span><span id="vixSentiment" class="value">--</span></div>
            <div class="row"><span class="label">Action</span><span id="vixAction" class="value">--</span></div>
            <div class="gradient-bar">
                <div class="gradient-fill"></div>
                <div class="vertical-indicator" id="cardVIXIndicator"></div>
            </div>
        </div>

        <!-- PCR -->
        <div class="card" id="cardPCR" data-sentiment="0">
            <h2>PCR</h2>
            <div class="row"><span class="label">PCR</span><span id="pcr" class="value">--</span></div>
            <div class="row"><span class="label">Sentiment</span><span id="pcrSentiment" class="value">--</span></div>
            <div class="row"><span class="label">Action</span><span id="pcrAction" class="value">--</span></div>
            <div class="gradient-bar">
                <div class="gradient-fill"></div>
                <div class="vertical-indicator" id="cardPCRIndicator"></div>
            </div>
        </div>

        <!-- RSI -->
        <div class="card" id="cardRSI" data-sentiment="0">
            <h2>RSI</h2>
            <div class="row"><span class="label">RSI (15m)</span><span id="rsi15" class="value">--</span></div>
            <div class="row"><span class="label">RSI (1Hr)</span><span id="rsi60" class="value">--</span></div>
            <div class="row"><span class="label">Sentiment</span><span id="rsiSentiment" class="value">--</span></div>
            <div class="row"><span class="label">Action</span><span id="rsiAction" class="value">--</span></div>
            <div class="gradient-bar">
                <div class="gradient-fill"></div>
                <div class="vertical-indicator" id="cardRSIIndicator"></div>
            </div>
        </div>

        <!-- MMI -->
        <div class="card" id="cardMMI" data-sentiment="0">
            <h2>Market Zone (MMI)</h2>
            <div class="row"><span class="label">Zone</span><span id="zoneLabel" class="value">--</span></div>
            <div class="row"><span class="label">Action</span><span id="mmiAction" class="value">--</span></div>
            <div class="gradient-bar">
                <div class="gradient-fill"></div>
                <div class="vertical-indicator" id="cardMMIIndicator"></div>
            </div>
        </div>

    </div>
</div>

<div id="marketbias" class="tabcontent">
    <div class="dashboard">
        <div class="card" id="cardBias" data-sentiment="0">
            <h2>Market Bias Summary</h2>
            <div class="row"><span class="label">Bias</span><span id="biasLabel" class="value">--</span></div>
            <div class="row"><span class="label">Score</span><span id="biasScore" class="value">--</span></div>
            <div class="row"><span class="label">VIX</span><span id="vixValue" class="value">--</span></div>
            <div class="row"><span class="label">Suggested Play</span><span id="suggestedPlay" class="value">--</span></div>
            <div class="row"><span class="label">CE Strike</span><span id="ceStrike" class="value">--</span></div>
            <div class="row"><span class="label">PE Strike</span><span id="peStrike" class="value">--</span></div>
            <div class="row"><span class="label">Warnings</span><span id="strikeWarnings" class="value">--</span></div>
            <div class="gradient-bar">
                <div class="gradient-fill"></div>
                <div class="vertical-indicator" id="cardBiasIndicator"></div>
            </div>
        </div>
    </div>
</div>

<div class="footer">Auto-refresh every 5 minutes</div>

<script>
// --- Sentiment mapping ---
function sentimentValue(sentiment){
    if(!sentiment) return 0;
    const s = sentiment.toLowerCase();
    if(s.includes("extreme buy") || s.includes("strong buy")) return 2;
    if(s.includes("buy")) return 1;
    if(s.includes("neutral") || s.includes("hold")) return 0;
    if(s.includes("sell")) return -1;
    if(s.includes("extreme sell") || s.includes("strong sell")) return -2;
    return 0;
}

function sentimentClass(sentiment){
    if(!sentiment) return "neutral";
    const s = sentiment.toLowerCase();
    if(s.includes("extreme buy") || s.includes("strong buy")) return "strong-bullish";
    if(s.includes("buy")) return "bullish";
    if(s.includes("neutral") || s.includes("hold")) return "neutral";
    if(s.includes("sell")) return "bearish";
    if(s.includes("extreme sell") || s.includes("strong sell")) return "strong-bearish";
    return "neutral";
}

function applyGradientBar(cardId, sentiment){
    const val = sentimentValue(sentiment);
    const fill = document.querySelector(`#${cardId} .gradient-fill`);
    const indicator = document.getElementById(`${cardId}Indicator`);
    const widthPercent = 50 + val * 25; // -2 â†’ 0%, 0 â†’ 50%, 2 â†’ 100%
    fill.style.width = widthPercent + "%";
    indicator.style.left = widthPercent + "%";
}

function applySentimentColor(elementId, sentiment){
    const el = document.getElementById(elementId);
    el.className = "value " + sentimentClass(sentiment);
    el.innerText = sentiment ?? "--";
}

// --- MMI zone color ---
function mmiZoneClass(zone){
    if(!zone) return "neutral";
    const z = zone.toLowerCase();
    if(z.includes("extreme fear")) return "strong-bearish";
    if(z.includes("fear")) return "bearish";
    if(z.includes("extreme greed")) return "strong-bullish";
    if(z.includes("greed") && !z.includes("extreme")) return "bullish";
    return "neutral";
}

function applyMMIColor(zone){
    const el = document.getElementById("zoneLabel");
    el.className = "value " + mmiZoneClass(zone);
    el.innerText = zone ?? "--";
}

// Move vertical pointer according to numeric value (0-100)
function applyMMIPointer(value){
    const indicator = document.getElementById("cardMMIIndicator");
    if(value !== undefined && !isNaN(value)){
        const pct = Math.max(0, Math.min(100, value)); // clamp 0-100
        indicator.style.left = pct + "%";
    } else {
        indicator.style.left = "50%";
    }
}

// Tabs
document.querySelectorAll(".tab").forEach(tab=>{
    tab.addEventListener("click",()=>{
        document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
        tab.classList.add("active");
        document.querySelectorAll(".tabcontent").forEach(tc=>tc.classList.remove("active"));
        document.getElementById(tab.dataset.tab).classList.add("active");
    });
});

// Fetch indicators
async function fetchIndicators(){
    try {
        const [indicesRes, vixRes, pcrRes, rsiRes, mmiRes] = await Promise.all([
            fetch("/api/indices"),
            fetch("/api/vix"),
            fetch("/api/pcr"),
            fetch("/api/rsi"),
            fetch("/api/mmi")
        ]);

        const indices = await indicesRes.json();
        const vixData = await vixRes.json();
        const pcrData = await pcrRes.json();
        const rsiData = await rsiRes.json();
        const mmiData = await mmiRes.json();

        document.getElementById("nifty50").innerText = indices.NIFTY50?.toFixed(2) ?? "--";
        document.getElementById("banknifty").innerText = indices.BANKNIFTY?.toFixed(2) ?? "--";
        document.getElementById("sensex").innerText = indices.SENSEX?.toFixed(2) ?? "--";
        applyGradientBar("cardIndices", indices.sentiment);

        document.getElementById("vix").innerText = vixData.vix?.toFixed(2) ?? "--";
        applySentimentColor("vixSentiment", vixData.sentiment);
        document.getElementById("vixAction").innerText = vixData.action ?? "--";
        applyGradientBar("cardVIX", vixData.sentiment);

        document.getElementById("pcr").innerText = pcrData.pcr?.toFixed(2) ?? "--";
        applySentimentColor("pcrSentiment", pcrData.sentiment);
        document.getElementById("pcrAction").innerText = pcrData.action ?? "--";
        applyGradientBar("cardPCR", pcrData.sentiment);

        document.getElementById("rsi15").innerText = rsiData.rsi15min?.toFixed(2) ?? "--";
        document.getElementById("rsi60").innerText = rsiData.rsi1hr?.toFixed(2) ?? "--";
        applySentimentColor("rsiSentiment", rsiData.sentiment);
        document.getElementById("rsiAction").innerText = rsiData.action ?? "--";
        applyGradientBar("cardRSI", rsiData.sentiment);

        applyMMIColor(mmiData.zone);
        applySentimentColor("mmiAction", mmiData.action);
        applyGradientBar("cardMMI", mmiData.sentiment);

        // Move vertical pointer based on numeric MMI (0-100)
        applyMMIPointer(mmiData.value);

    } catch(e){ console.error("Indicators fetch failed", e);}
}

// Fetch market bias
async function fetchMarketBias(){
    try{
        const res = await fetch("/api/marketbias");
        const data = await res.json();

        applySentimentColor("biasLabel", data.bias);
        document.getElementById("biasScore").innerText = data.score ?? "--";
        document.getElementById("vixValue").innerText = data.vix ?? "--";
        document.getElementById("suggestedPlay").innerText = data.action ?? "--";
        document.getElementById("ceStrike").innerText = data.strikes?.ce_strike ?? "--";
        document.getElementById("peStrike").innerText = data.strikes?.pe_strike ?? "--";
        document.getElementById("strikeWarnings").innerText = (data.strikes?.warnings||[]).join(", ") || "--";

        applyGradientBar("cardBias", data.bias ?? "neutral");

    } catch(e){ console.error("Market bias fetch failed", e);}
}

// Refresh
async function refreshDashboard(){
    await Promise.all([fetchIndicators(), fetchMarketBias()]);
    console.log("Dashboard refreshed", new Date().toLocaleTimeString());
}

refreshDashboard();
setInterval(refreshDashboard, 300000);
</script>

</body>
</html>

